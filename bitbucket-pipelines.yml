image: node:14-buster

options:
  max-time: 20 # max time in minutes for each step

definitions:
  caches:
    nodemodules: 'node_modules/'
#    nextcache: 'dist/**/.next/cache'
    yarncustom: '/usr/local/share/.cache/yarn'
#    nxcache: 'dist/'
    cypress: '/root/.cache/Cypress'
#  services:
#    docker:
#      memory: 2048

pipelines:
  pull-requests:
    '**':
      - step:
          name: PR pipeline
          caches:
            - nodemodules
            - yarncustom
          script:

            # Get an oauth access token using the client credentials, parsing out the token with jq.
            - apt-get update && apt-get install -y curl jq
            - >
              export access_token=$(curl -s -X POST -u "${BITBUCKET_CLIENT_ID}:${BITBUCKET_CLIENT_SECRET}" \
                https://bitbucket.org/site/oauth2/access_token \
                -d grant_type=client_credentials -d scopes="pullrequest"| jq --raw-output '.access_token')

            # Configure git to use the oauth token.
            - >
              curl -sS -H "Authorization: Bearer ${access_token}" "https://api.bitbucket.org/2.0/repositories/${BITBUCKET_REPO_OWNER}/${BITBUCKET_REPO_SLUG}/pullrequests/${BITBUCKET_PR_ID}"
            - >
              export PR_AUTHOR=$(curl -sS -H "Authorization: Bearer ${access_token}" "https://api.bitbucket.org/2.0/repositories/${BITBUCKET_REPO_OWNER}/${BITBUCKET_REPO_SLUG}/pullrequests/${BITBUCKET_PR_ID}" | jq -r '.author.display_name')

            - yarn install --pure-lockfile --prefer-offline
            - yarn affected --base=origin/master --target=lint --with-deps --parallel
            - yarn affected --base=origin/master --target=export --prod
            - yarn affected --base=origin/master --target=deploy

    #          - yarn run nx affected --all --target=build
    #          - yarn run nx affected --target=lint --base=master~1
    #          - yarn run nx affected --target=test --base=master~1 --head=master
    #          - yarn run nx affected --target=build --base=master~1

  default:
    - step:
        name: Build and Test branch
        caches:
          - nodemodules
          - yarncustom
        script:
          - git fetch origin master --refmap="+refs/heads/*:refs/remotes/origin/*"
          - yarn install --pure-lockfile --prefer-offline
          - yarn affected --base=origin/master --target=lint --parallel

          # TODO: move these to eslint so that `yarn lint` picks up these errors instead
          - npm i -g typescript
          - tsc --noEmit -p apps/backend/
          - tsc --noEmit -p apps/connect/
          - tsc --noEmit -p apps/connect-e2e/
          - tsc --noEmit -p apps/mgmt/
          - tsc --noEmit -p apps/mgmt-e2e/
          - tsc --noEmit -p apps/ui-e2e/
          - tsc --noEmit -p apps/web/
          - tsc --noEmit -p apps/web-e2e/
          - tsc --noEmit -p libs/ui/tsconfig.lib.json
          - tsc --noEmit -p libs/yup/tsconfig.lib.json


  branches:
    master:
      - step:
          #size: 2x
          name: Production
          caches:
            - nodemodules
            - yarncustom
#            - cypress
          script:
            - export LAST_COMMIT_LOG=$(git log HEAD~1 -1 | tail -n +4)
            - yarn install --pure-lockfile --prefer-offline
#            - yarn affected:lint --base=HEAD~1
            - yarn affected:lint --base=HEAD~1 --with-deps --parallel
#            - yarn affected:test --base=HEAD~1 --with-deps
#            - yarn affected:build --base=HEAD~1 --prod
#            - apt update -y && apt install -y libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libgconf-2-4 libnss3 libxss1 libasound2 libxtst6 xauth xvfb
#            - yarn cypress install || true
#            - yarn affected:e2e --base=HEAD~1 || true

            # Get an oauth access token using the client credentials, parsing out the token with jq.
            - apt-get update && apt-get install -y curl jq && jq --version && curl --version
            - git remote set-url origin "${BITBUCKET_GIT_SSH_ORIGIN}"

            #            - git config user.name "Pipeline"
            #            - git config user.email nobody@pabau.com
            - yarn version --message "[skip ci] bumping version (patch)" --patch --non-interactive --no-progress
            - git push && git push --tags
            - export PACKAGE_JSON_VERSION=$(jq -r .version < package.json)

            - yarn affected --base=HEAD~2 --target=export --prod
            - yarn affected --base=HEAD~2 --target=deploy --prod
#      - step:
#          size: 2x
#          name: e2e
#          caches:
#            - nextcache
#

